name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  release:
    types: [ created ]

jobs:
  lint:
    name: Python Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install linters
        run: pip install flake8 pyflakes
      - name: Lint
        run: |
          flake8 src/ --max-line-length=120 --ignore=E501,W503 --count

  validate-metainfo:
    name: Validate AppStream metainfo
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install appstream-util
        run: sudo apt-get install -y appstream-util
      - name: Validate metainfo
        run: appstream-util validate --nonet data/metainfo/org.linuxhwmonitor.App.metainfo.xml

  flatpak:
    name: Build Flatpak
    runs-on: ubuntu-latest
    needs: [lint]
    container:
      image: bilelmoussaoui/flatpak-github-actions:freedesktop-23.08
      options: --privileged
    steps:
      - uses: actions/checkout@v4
      - name: Build Flatpak
        uses: flatpak/flatpak-github-actions/flatpak-builder@v6
        with:
          bundle: linuxhwmonitor.flatpak
          manifest-path: flatpak/org.linuxhwmonitor.App.json
          cache-key: flatpak-builder-${{ github.sha }}

  release:
    name: Upload release assets
    runs-on: ubuntu-latest
    needs: [flatpak]
    if: github.event_name == 'release'
    steps:
      - uses: actions/checkout@v4
      - name: Download Flatpak bundle
        uses: actions/download-artifact@v4
        with:
          name: linuxhwmonitor.flatpak
      - name: Upload to release
        uses: softprops/action-gh-release@v2
        with:
          files: linuxhwmonitor.flatpak
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
